# Week 6 â€” 7 Deploying Serverless Containers
This was technically the seventh week of the Bootcamp. 

(The Hyperlinks in the table below link to the training videos)

**Todo Checklist:**
- [x] [FREE AWS Cloud Project Bootcamp (Week 5) - NoSQL and Caching](https://www.youtube.com/watch?v=5oZHNOaL8Og)
- [x] [ECS Security by Ashish](https://www.youtube.com/watch?v=zz2FQAk1I28&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=57 )
- [x] [Provision ECS Cluster](https://www.youtube.com/watch?v=QIZx2NhdCMI&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=58 )
- [x] [Create ECR repo and push image for backend-flask](https://www.youtube.com/watch?v=QIZx2NhdCMI&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=58 )
- [x] [Deploy Backend Flask app as a service to Fargate](https://www.youtube.com/watch?v=QIZx2NhdCMI&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=58 )
- [x] [Create ECR repo and push image for fronted-react-js](https://www.youtube.com/watch?v=HHmpZ5hqh1I&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=59 )
- [x] [Deploy Frontend React JS app as a service to Fargate](https://www.youtube.com/watch?v=HHmpZ5hqh1I&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=59 )
- [x] [Provision and configure Application Load Balancer along with target groups](https://www.youtube.com/watch?v=HHmpZ5hqh1I&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=59 )
- [x] [Manage your domain useing Route53 via hosted zone](https://www.youtube.com/watch?v=HHmpZ5hqh1I&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=59 )
- [x] [Create an SSL cerificate via ACM](https://www.youtube.com/watch?v=HHmpZ5hqh1I&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=59 )
- [x] [Setup a record set for naked domain to point to frontend-react-js](https://www.youtube.com/watch?v=HHmpZ5hqh1I&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=59 )
- [x] [Setup a record set for api subdomain to point to the backend-flask](https://www.youtube.com/watch?v=HHmpZ5hqh1I&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=59 )
- [] [Configure CORS to only permit traffic from our domain](https://www.youtube.com/watch?v=HHmpZ5hqh1I&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=59 )
- [] [Secure Flask by not running in debug mode](https://www.youtube.com/watch?v=9OQZSBKzIgs&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=60 )
- [] [Implement Refresh Token for Amazon Cognito](https://www.youtube.com/watch?v=LNLP2dxa5EQ&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=63 )
- [] [Refactor bin directory to be top level](https://www.youtube.com/watch?v=HyJOjBjieb4&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=62 )
- [] [Configure task defintions to contain x-ray and turn on Container Insights](https://www.youtube.com/watch?v=G_8_xtS2MsY&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=64 )
- [] [Change Docker Compose to explicitly use a user-defined network](https://www.youtube.com/watch?v=G_8_xtS2MsY&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=64 )
- [] [Create Dockerfile specfically for production use case](https://www.youtube.com/watch?v=G_8_xtS2MsY&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=64 )
- [] [Using ruby generate out env dot files for docker using erb templates](https://www.youtube.com/watch?v=G_8_xtS2MsY&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=64 )


- [] Complete 100% of the tasks

<hr/>


|    | Table of contents - Steps taken to complete Week 6 assignments                                                                                                                                                                         |
|----|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1  | []()                                  |
| 2  | []()                                  |
| 3  | []()                                  |
| 4  | []()                                  |
| 5  | []()                                  |
| 6  | []()                                  |
| 7  | []()                                  |
| 8  | []()                                  |
| 9  | []()                                  |
| 10 | []()                                  |
| 11 | []()                                  |
| 12 | []()                                  |
| 13 | []()                                  |
| 14 | []()                                  |
| 15 | []()                                  |
| 16 | []()                                  |
| 17 | []()                                  |
| 18 | []()                                  |
| 19 | []()                                  |
| 20 | []()                                  |
| 21 | []()                                  |
| 22 | []()                                  |
| 23 | []()                                  |
| 24 | []()                                  |
| 25 | []()                                  |
| 26 | []()                                  |
| 27 | []()                                  |
| 28 | []()                                  |
| 29 | []()                                  |
| 30 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |                                                                                                                              
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
                                                                                                                               

## Item 1
![Item 1](https://github.com/Stevecmd/aws-bootcamp-cruddur-2023/blob/main/journal/Week%204/Lambda%20setup%201.JPG)

## Item 2
![]()

## Item 3
![]()

## Item 4
![]()

## Item 5
![]()

## Item 6
![]()

## Item 7
![]()

## Item 8
![]()

## Item 9
![]()

## Item 10
![]()

## Item 11
![]()

## Item 12
![]()

## Item 13
![]()

## Item 14
![]()

## Item 15
![]()

## Item 16
![]()

## Item 17
![]()

## Item 18
![]()

## Item 19
![]()

## Item 20
![]()




I had previously removed some of the resources so the first step is to redeploy them:
1. Make sure all your environmental requirements are installed:
`pip install -r requirements.txt`
NB: We are not using the RDS Database but one may enable it at the end to confirm everything is working

Install AWS CLI
		`curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"`
		`unzip awscliv2.zip`
		`sudo ./aws/install`

2. Create a health check at app level(app.py),  
3. Create a health check at flask container level
`chmod u+x ./bin/flask/health-check`
4. Create cloudwatch log groups:
- App level log group
`aws logs create-log-group --log-group-name "/cruddur"`
`aws logs put-retention-policy --log-group-name "/cruddur" --retention-in-days 1`

- Fargate container log group
`aws logs create-log-group --log-group-name "/cruddur/fargate-cluster"`
`aws logs put-retention-policy --log-group-name "/cruddur/fargate-cluster" --retention-in-days 1`


Create ECS cluster
```aws ecs create-cluster \
--cluster-name cruddur \
--service-connect-defaults namespace=cruddur
```

Create Cruddur-python ecr repo
```aws ecr create-repository \
  --repository-name cruddur-python \
  --image-tag-mutability MUTABLE
  ```

Install session manager plugin
`curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "session-manager-plugin.deb" `
`sudo dpkg -i session-manager-plugin.deb`

Verify session manager is working:
`session-manager-plugin`

Login to ECR
```aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com" ```

After login, we can now push the containers.

Set URL
`export ECR_PYTHON_URL="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/cruddur-python"`
`echo $ECR_PYTHON_URL`


Create the Cruddur services Security Group

```export CRUD_SERVICE_SG=$(aws ec2 create-security-group \
  --group-name "crud-srv-sg" \
  --description "Security group for Cruddur services on ECS" \
  --vpc-id $DEFAULT_VPC_ID \
  --query "GroupId" --output text)
echo $CRUD_SERVICE_SG
```

```aws ec2 authorize-security-group-ingress \
  --group-id $CRUD_SERVICE_SG \
  --protocol tcp \
  --port 80 \
  --cidr 0.0.0.0/0
  ```
  
```export CRUD_SERVICE_SG=$(aws ec2 describe-security-groups \
  --filters Name=group-name,Values=crud-srv-sg \
  --query 'SecurityGroups[*].GroupId' \
  --output text)
  ```
  
```aws ec2 authorize-security-group-ingress \
  --group-id $DB_SG_ID \
  --protocol tcp \
  --port 5432 \
  --source-group $CRUD_SERVICE_SG \
  --tag-specifications 'ResourceType=security-group,Tags=[{Key=Name,Value=BACKENDFLASK}]'
  ```

```export DEFAULT_VPC_ID=$(aws ec2 describe-vpcs \
--filters "Name=isDefault, Values=true" \
--query "Vpcs[0].VpcId" \
--output text)
echo $DEFAULT_VPC_ID
```

```export DEFAULT_SUBNET_IDS=$(aws ec2 describe-subnets  \
 --filters Name=vpc-id,Values=$DEFAULT_VPC_ID \
 --query 'Subnets[*].SubnetId' \
 --output json | jq -r 'join(",")')
echo $DEFAULT_SUBNET_IDS
```

Confirm settings:
```echo $AWS_ACCOUNT_ID
export DEFAULT_VPC_ID="vpc-<random id number of your vpc>"
echo $DEFAULT_VPC_ID
```

Pull Image
`docker pull python:3.10-slim-buster`

Confirm image pulled
`docker images`

Tag Image
`docker tag python:3.10-slim-buster $ECR_PYTHON_URL:3.10-slim-buster`

Push Image
`docker push $ECR_PYTHON_URL:3.10-slim-buster`

![Test the backend image and db connection]
(https://github.com/Stevecmd/aws-bootcamp-cruddur-2023/blob/main/journal/Week%206/compose%20up%20db%20and%20backend.JPG)
`docker-compose up backend-flask db`

![Item 1](https://github.com/Stevecmd/aws-bootcamp-cruddur-2023/blob/main/journal/Week%204/Lambda%20setup%201.JPG)

Create backend-flask Repo
```aws ecr create-repository \
  --repository-name backend-flask \
  --image-tag-mutability MUTABLE
  ```

Set URL
`export ECR_BACKEND_FLASK_URL="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/backend-flask"`
`echo $ECR_BACKEND_FLASK_URL`

#Make sure to be in backend-flask directory
Build Image
`docker build -t backend-flask .`

Tag Image
`docker tag backend-flask:latest $ECR_BACKEND_FLASK_URL:latest`

Push Image
`docker push $ECR_BACKEND_FLASK_URL:latest`

To create ECS task we should create tasks first
** task role is execution permissions while executionrole are used in execution


Create Parameters in parameter store
run:
`export OTEL_EXPORTER_OTLP_HEADERS="x-honeycomb-team=${HONEYCOMB_API_KEY}"`
`echo $OTEL_EXPORTER_OTLP_HEADERS`

Create ExecutionRole then policy
```aws iam create-role \    
--role-name CruddurServiceExecutionPolicy  \   
--assume-role-policy-document file://aws/policies/service-assume-role-execution-policy.json
```

```aws iam put-role-policy \
  --policy-name CruddurServiceExecutionPolicy \
  --role-name CruddurServiceExecutionRole \
  --policy-document file://aws/policies/service-execution-policy.json
  ```


Register Task Definitions
Passing Senstive Data to Task Definition
```aws ssm put-parameter --type "SecureString" --name "/cruddur/backend-flask/AWS_ACCESS_KEY_ID" --value $AWS_ACCESS_KEY_ID
aws ssm put-parameter --type "SecureString" --name "/cruddur/backend-flask/AWS_SECRET_ACCESS_KEY" --value $AWS_SECRET_ACCESS_KEY
aws ssm put-parameter --type "SecureString" --name "/cruddur/backend-flask/CONNECTION_URL" --value $PROD_CONNECTION_URL
aws ssm put-parameter --type "SecureString" --name "/cruddur/backend-flask/ROLLBAR_ACCESS_TOKEN" --value $ROLLBAR_ACCESS_TOKEN
aws ssm put-parameter --type "SecureString" --name "/cruddur/backend-flask/OTEL_EXPORTER_OTLP_HEADERS" --value "x-honeycomb-team=$HONEYCOMB_API_KEY"
```

Create the service execution policy then role then
* replace POLICY_ARN
`aws iam attach-role-policy --policy-arn POLICY_ARN --role-name CruddurServiceExecutionRole`
then
`aws iam attach-role-policy --policy-arn arn:aws:iam::aws:policy/CloudWatchFullAccess --role-name CruddurTaskRole`
`aws iam attach-role-policy --policy-arn arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess --role-name CruddurTaskRole`

Confirm on console: Full cloudwatch access to CruddurServiceExecutionRole

Create task definitions
For backend then register: 
`aws ecs register-task-definition --cli-input-json file://aws/task-definitions/backend-flask.json`


*** edit the default subnets in the task definition

Create service
aws ecs create-service --cli-input-json file://aws/json/service-backend-flask.json

Connect to the backend-flask container

# edit task number below
```aws ecs execute-command \
--region $AWS_DEFAULT_REGION \
--cluster cruddur \
--task <task-number> \
--container backend-flask \
--command "/bin/bash" \
--interactive
```

check health check
`./bin/flaskhealth-check`

create LB
1st SG 
create TG
Create LB

Create service
`aws ecs create-service --cli-input-json file://aws/json/service-frontend-react-js.json`

* Create dockerfile.prod in frontend

Create front end repo
```aws ecr create-repository \
  --repository-name frontend-react-js \
  --image-tag-mutability MUTABLE
  ```

Build backend and map port
```docker build \
--build-arg REACT_APP_BACKEND_URL="http://cruddur-alb-39461277.us-east-1.elb.amazonaws.com:4567" \
--build-arg REACT_APP_AWS_PROJECT_REGION="$AWS_DEFAULT_REGION" \
--build-arg REACT_APP_AWS_COGNITO_REGION="$AWS_DEFAULT_REGION" \
--build-arg REACT_APP_AWS_USER_POOLS_ID="ca-central-1_<unique-number>" \
--build-arg REACT_APP_CLIENT_ID="<unique client ID>" \
-t frontend-react-js \
-f Dockerfile.prod \
.
```

Tag Image
`docker tag frontend-react-js:latest $ECR_FRONTEND_REACT_URL:latest`

Push it
`docker push $ECR_FRONTEND_REACT_URL:latest`

If you want to run and test it

`docker run --rm -p 3000:3000 -it frontend-react-js`

Part 2
Create frontend service if not already running:
`aws ecs create-service --cli-input-json file://aws/json/service-frontend-react-js.json`

Build frontend image locally - must be in front end react folder
```docker build \
--build-arg REACT_APP_BACKEND_URL="https://4567-$GITPOD_WORKSPACE_ID.$GITPOD_WORKSPACE_CLUSTER_HOST" \
--build-arg REACT_APP_AWS_PROJECT_REGION="$AWS_DEFAULT_REGION" \
--build-arg REACT_APP_AWS_COGNITO_REGION="$AWS_DEFAULT_REGION" \
--build-arg REACT_APP_AWS_USER_POOLS_ID="us-east-1_<unique-number>" \
--build-arg REACT_APP_CLIENT_ID="<unique client ID>" \
-t frontend-react-js \
-f Dockerfile.prod \
.
```

If you want to run and test it (one can do it locally)

`docker ps --to get <container id>`

`docker run --rm -p 3000:3000 -it frontend-react-js`

`docker inspect --to get <container id>`

Register Task Definition
`aws ecs register-task-definition --cli-input-json file://aws/task-definitions/frontend-react-js.json`

		Install AWS CLI
		```curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
		unzip awscliv2.zip
		sudo ./aws/install
        ```

# Connecting to the frontend container once running: 
`./bin/ecs/connect-to-frontend-react-js <task number>`


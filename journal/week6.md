# Week 6 â€” 7 Deploying Serverless Containers
This was technically the seventh week of the Bootcamp. 

(The Hyperlinks in the table below link to the training videos)

**Todo Checklist:**
- [x] [FREE AWS Cloud Project Bootcamp (Week 5) - NoSQL and Caching](https://www.youtube.com/watch?v=5oZHNOaL8Og)
- [x] [ECS Security by Ashish](https://www.youtube.com/watch?v=zz2FQAk1I28&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=57 )
- [x] [Provision ECS Cluster](https://www.youtube.com/watch?v=QIZx2NhdCMI&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=58 )
- [x] [Create ECR repo and push image for backend-flask](https://www.youtube.com/watch?v=QIZx2NhdCMI&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=58 )
- [x] [Deploy Backend Flask app as a service to Fargate](https://www.youtube.com/watch?v=QIZx2NhdCMI&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=58 )
- [x] [Create ECR repo and push image for fronted-react-js](https://www.youtube.com/watch?v=HHmpZ5hqh1I&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=59 )
- [x] [Deploy Frontend React JS app as a service to Fargate](https://www.youtube.com/watch?v=HHmpZ5hqh1I&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=59 )
- [x] [Provision and configure Application Load Balancer along with target groups](https://www.youtube.com/watch?v=HHmpZ5hqh1I&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=59 )
- [x] [Manage your domain useing Route53 via hosted zone](https://www.youtube.com/watch?v=HHmpZ5hqh1I&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=59 )
- [x] [Create an SSL cerificate via ACM](https://www.youtube.com/watch?v=HHmpZ5hqh1I&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=59 )
- [x] [Setup a record set for naked domain to point to frontend-react-js](https://www.youtube.com/watch?v=HHmpZ5hqh1I&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=59 )
- [x] [Setup a record set for api subdomain to point to the backend-flask](https://www.youtube.com/watch?v=HHmpZ5hqh1I&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=59 )
- [] [Configure CORS to only permit traffic from our domain](https://www.youtube.com/watch?v=HHmpZ5hqh1I&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=59 )
- [] [Secure Flask by not running in debug mode](https://www.youtube.com/watch?v=9OQZSBKzIgs&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=60 )
- [] [Implement Refresh Token for Amazon Cognito](https://www.youtube.com/watch?v=LNLP2dxa5EQ&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=63 )
- [] [Refactor bin directory to be top level](https://www.youtube.com/watch?v=HyJOjBjieb4&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=62 )
- [] [Configure task defintions to contain x-ray and turn on Container Insights](https://www.youtube.com/watch?v=G_8_xtS2MsY&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=64 )
- [] [Change Docker Compose to explicitly use a user-defined network](https://www.youtube.com/watch?v=G_8_xtS2MsY&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=64 )
- [] [Create Dockerfile specfically for production use case](https://www.youtube.com/watch?v=G_8_xtS2MsY&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=64 )
- [] [Using ruby generate out env dot files for docker using erb templates](https://www.youtube.com/watch?v=G_8_xtS2MsY&list=PLBfufR7vyJJ7k25byhRXJldB5AiwgNnWv&index=64 )


- [] Complete 100% of the tasks

<hr/>


|    | Table of contents - Steps taken to complete Week 6 assignments                                                                                                                                                                         |
|----|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1  | []()                                  |
| 2  | []()                                  |
| 3  | []()                                  |
| 4  | []()                                  |
| 5  | []()                                  |
| 6  | []()                                  |
| 7  | []()                                  |
| 8  | []()                                  |
| 9  | []()                                  |
| 10 | []()                                  |
| 11 | []()                                  |
| 12 | []()                                  |
| 13 | []()                                  |
| 14 | []()                                  |
| 15 | []()                                  |
| 16 | []()                                  |
| 17 | []()                                  |
| 18 | []()                                  |
| 19 | []()                                  |
| 20 | []()                                  |
| 21 | []()                                  |
| 22 | []()                                  |
| 23 | []()                                  |
| 24 | []()                                  |
| 25 | []()                                  |
| 26 | []()                                  |
| 27 | []()                                  |
| 28 | []()                                  |
| 29 | []()                                  |
| 30 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |                                                                                                                              
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
| 10 | []()                                  |
                                                                                                                               

## Item 1
![Item 1](https://github.com/Stevecmd/aws-bootcamp-cruddur-2023/blob/main/journal/Week%204/Lambda%20setup%201.JPG)

## Item 2
![]()

## Item 3
![]()

## Item 4
![]()

## Item 5
![]()

## Item 6
![]()

## Item 7
![]()

## Item 8
![]()

## Item 9
![]()

## Item 10
![]()

## Item 11
![]()

## Item 12
![]()

## Item 13
![]()

## Item 14
![]()

## Item 15
![]()

## Item 16
![]()

## Item 17
![]()

## Item 18
![]()

## Item 19
![]()

## Item 20
![]()




I had previously removed some of the resources so the first step is to redeploy them:
1. Make sure all your environmental requirements are installed:
`pip install -r requirements.txt`
NB: We are not using the RDS Database but one may enable it at the end to confirm everything is working
Run the script located at: `backend-flask/bin/db/test`
Ensure the script is executable by running:
`chmod u+x backend-flask/bin/db/test`

Install AWS CLI

`curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"`
`unzip awscliv2.zip`
`sudo ./aws/install`

2. Create a health check at app level(app.py)

```@app.route('/api/health-check')
def health_check():
  return {'success': True}, 200
  ```
Ensure the script is executable by running:
`chmod u+x bin/flask/health-check`
Run the script: `bin/flask/health-check`

![Health check](journal/Week 6/backend health check running.JPG)

3. Create a health check at flask container level
`chmod u+x ./bin/flask/health-check`

![Frontend health check](https://github.com/Stevecmd/aws-bootcamp-cruddur-2023/blob/main/journal/Week%206/working%20health%20check%20docker%20image.JPG)

4. Create cloudwatch log groups:
- App level log group

`aws logs create-log-group --log-group-name "/cruddur"`
`aws logs put-retention-policy --log-group-name "/cruddur" --retention-in-days 1`

![Logs after creation and use of the app](https://github.com/Stevecmd/aws-bootcamp-cruddur-2023/blob/main/journal/Week%206/backend%20flask%20logs.JPG)

- Fargate container log group
`aws logs create-log-group --log-group-name "/cruddur/fargate-cluster"`
`aws logs put-retention-policy --log-group-name "/cruddur/fargate-cluster" --retention-in-days 1`


Create ECS cluster
```aws ecs create-cluster \
--cluster-name cruddur \
--service-connect-defaults namespace=cruddur
```

Create Cruddur-python ecr repo
```aws ecr create-repository \
  --repository-name cruddur-python \
  --image-tag-mutability MUTABLE
  ```

Install session manager plugin

`curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb" -o "session-manager-plugin.deb" `
`sudo dpkg -i session-manager-plugin.deb`

Verify session manager is working:
`session-manager-plugin`

Login to ECR

```aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin "$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com" ```

After login, we can now push the containers.

Set URL of the Cruddur-python ecr repo created

`export ECR_PYTHON_URL="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/cruddur-python"`
`echo $ECR_PYTHON_URL`


Create the Cruddur services Security Group

```export CRUD_SERVICE_SG=$(aws ec2 create-security-group \
  --group-name "crud-srv-sg" \
  --description "Security group for Cruddur services on ECS" \
  --vpc-id $DEFAULT_VPC_ID \
  --query "GroupId" --output text)
echo $CRUD_SERVICE_SG
```

```aws ec2 authorize-security-group-ingress \
  --group-id $CRUD_SERVICE_SG \
  --protocol tcp \
  --port 80 \
  --cidr 0.0.0.0/0
  ```
  
```export CRUD_SERVICE_SG=$(aws ec2 describe-security-groups \
  --filters Name=group-name,Values=crud-srv-sg \
  --query 'SecurityGroups[*].GroupId' \
  --output text)
  ```
  
```aws ec2 authorize-security-group-ingress \
  --group-id $DB_SG_ID \
  --protocol tcp \
  --port 5432 \
  --source-group $CRUD_SERVICE_SG \
  --tag-specifications 'ResourceType=security-group,Tags=[{Key=Name,Value=BACKENDFLASK}]'
  ```

```export DEFAULT_VPC_ID=$(aws ec2 describe-vpcs \
--filters "Name=isDefault, Values=true" \
--query "Vpcs[0].VpcId" \
--output text)
echo $DEFAULT_VPC_ID
```

```export DEFAULT_SUBNET_IDS=$(aws ec2 describe-subnets  \
 --filters Name=vpc-id,Values=$DEFAULT_VPC_ID \
 --query 'Subnets[*].SubnetId' \
 --output json | jq -r 'join(",")')
echo $DEFAULT_SUBNET_IDS
```

Confirm settings:
```echo $AWS_ACCOUNT_ID
export DEFAULT_VPC_ID="vpc-<random id number of your vpc>"
echo $DEFAULT_VPC_ID
```

Pull Image of python:3.10-slim-buster
`docker pull python:3.10-slim-buster`

Confirm image pulled
`docker images`

Tag Image
`docker tag python:3.10-slim-buster $ECR_PYTHON_URL:3.10-slim-buster`

Push Image to ECR
`docker push $ECR_PYTHON_URL:3.10-slim-buster`

![Compose up db and backend](https://github.com/Stevecmd/aws-bootcamp-cruddur-2023/blob/main/journal/Week%206/compose%20up%20db%20and%20backend.JPG)

Or run `docker-compose up backend-flask db`

from the dockerfile of backend-fask change the following line

```FROM python:3.10-slim-buster

  ENV FLASK_ENV=development```

replace your AWS account number below
```FROM <AWS account number>.dkr.ecr.us-east-1.amazonaws.com/cruddur-python:3.10-slim-buster

ENV PORT=4567 ```

Create backend-flask Repo

```aws ecr create-repository \
  --repository-name backend-flask \
  --image-tag-mutability MUTABLE
  ```

Set URL of backend-flask Repo

`export ECR_BACKEND_FLASK_URL="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/backend-flask"`
`echo $ECR_BACKEND_FLASK_URL`

#Make sure to be in backend-flask directory
Build Image
`docker build -t backend-flask .`

Tag Image
`docker tag backend-flask:latest $ECR_BACKEND_FLASK_URL:latest`

Push Image
`docker push $ECR_BACKEND_FLASK_URL:latest`

To create ECS task we should create tasks first
** task role is execution permissions while executionrole are used in execution

Create Parameters in parameter store
run:
`export OTEL_EXPORTER_OTLP_HEADERS="x-honeycomb-team=${HONEYCOMB_API_KEY}"`
`echo $OTEL_EXPORTER_OTLP_HEADERS`

![Confirm on console that parameters were saved](https://github.com/Stevecmd/aws-bootcamp-cruddur-2023/blob/main/journal/Week%206/Confirm%20saved%20parameters.JPG)

Create ExecutionRole then policy
ROLE
```aws iam create-role \    
--role-name CruddurServiceExecutionPolicy  \   
--assume-role-policy-document file://aws/policies/service-assume-role-execution-policy.json
```

POLICY
```aws iam put-role-policy \
  --policy-name CruddurServiceExecutionPolicy \
  --role-name CruddurServiceExecutionRole \
  --policy-document file://aws/policies/service-execution-policy.json
  ```
create the new trust entities in the json file on this path aws/policies/service-assume-role-execution-policy.json
```
{
  "Version":"2012-10-17",
  "Statement":[{
      "Action":["sts:AssumeRole"],
      "Effect":"Allow",
      "Principal":{
        "Service":["ecs-tasks.amazonaws.com"]
    }}]
}
```
Create the service-execution-policy file under the path aws/policies/service-execution-policy.json
```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "ecr:GetAuthorizationToken",
                "ecr:BatchCheckLayerAvailability",
                "ecr:GetDownloadUrlForLayer",
                "ecr:BatchGetImage",
                "logs:CreateLogStream",
                "logs:PutLogEvents"
            ],
            "Resource": "*"
        },
        {
            "Sid": "VisualEditor1",
            "Effect": "Allow",
            "Action": [
                "ssm:GetParameters",
                "ssm:GetParameter"
            ],
            "Resource": "arn:aws:ssm:eu-west-2:238967891447:parameter/cruddur/backend-flask/*"
        }
    ]
}
```

Create the service execution policy then role then
* replace POLICY_ARN
`aws iam attach-role-policy --policy-arn POLICY_ARN --role-name CruddurServiceExecutionRole`
then
`aws iam attach-role-policy --policy-arn arn:aws:iam::aws:policy/CloudWatchFullAccess --role-name CruddurTaskRole`
`aws iam attach-role-policy --policy-arn arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess --role-name CruddurTaskRole`

Confirm on console: Full cloudwatch access to CruddurServiceExecutionRole

Register Task Definitions
Passing Senstive Data to Task Definition
```aws ssm put-parameter --type "SecureString" --name "/cruddur/backend-flask/AWS_ACCESS_KEY_ID" --value $AWS_ACCESS_KEY_ID
aws ssm put-parameter --type "SecureString" --name "/cruddur/backend-flask/AWS_SECRET_ACCESS_KEY" --value $AWS_SECRET_ACCESS_KEY
aws ssm put-parameter --type "SecureString" --name "/cruddur/backend-flask/CONNECTION_URL" --value $PROD_CONNECTION_URL
aws ssm put-parameter --type "SecureString" --name "/cruddur/backend-flask/ROLLBAR_ACCESS_TOKEN" --value $ROLLBAR_ACCESS_TOKEN
aws ssm put-parameter --type "SecureString" --name "/cruddur/backend-flask/OTEL_EXPORTER_OTLP_HEADERS" --value "x-honeycomb-team=$HONEYCOMB_API_KEY"
```
Confirm parameters have been saved
![Saved parameters on console ](https://github.com/Stevecmd/aws-bootcamp-cruddur-2023/blob/main/journal/Week%206/Confirm%20saved%20paramters.JPG)

Create the taskrole
```aws iam create-role \
    --role-name CruddurTaskRole \
    --assume-role-policy-document "{
  \"Version\":\"2012-10-17\",
  \"Statement\":[{
    \"Action\":[\"sts:AssumeRole\"],
    \"Effect\":\"Allow\",
    \"Principal\":{
      \"Service\":[\"ecs-tasks.amazonaws.com\"]
    }
  }]
}" 
```

attach the SSM access policy
```
aws iam put-role-policy \
  --policy-name SSMAccessPolicy \
  --role-name CruddurTaskRole \
  --policy-document "{
  \"Version\":\"2012-10-17\",
  \"Statement\":[{
    \"Action\":[
      \"ssmmessages:CreateControlChannel\",
      \"ssmmessages:CreateDataChannel\",
      \"ssmmessages:OpenControlChannel\",
      \"ssmmessages:OpenDataChannel\"
    ],
    \"Effect\":\"Allow\",
    \"Resource\":\"*\"
  }]
}
```

give the cruddurtaskrole access to cloudwatch
`aws iam attach-role-policy --policy-arn arn:aws:iam::aws:policy/CloudWatchFullAccess --role-name CruddurTaskRole`

attach a policy to write to the xraydaemon
`aws iam attach-role-policy --policy-arn arn:aws:iam::aws:policy/AWSXRayDaemonWriteAccess --role-name CruddurTaskRole`

Create backend task definitions
For backend then register: 
`aws ecs register-task-definition --cli-input-json file://aws/task-definitions/backend-flask.json`


*** Edit the default vpc, security group, subnets, in the task definition

Create service
`aws ecs create-service --cli-input-json file://aws/json/service-backend-flask.json`

Connect to the backend-flask container
*** Session manager must have been installed

# Edit the task number below to connect to the backend flask service
```aws ecs execute-command \
--region $AWS_DEFAULT_REGION \
--cluster cruddur \
--task <task-number> \
--container backend-flask \
--command "/bin/bash" \
--interactive
```

![Connect to Backend flask through SSM](https://github.com/Stevecmd/aws-bootcamp-cruddur-2023/blob/main/journal/Week%206/succesfull%20connection%20to%20task.JPG)

Ensure to have the following script in your gitpod.yml file
```
    before: |
      cd /workspace
      curl "https://s3.amazonaws.com/session-manager-downloads/plugin/latest/ubuntu_64bit/session-manager-plugin.deb"
      sudo dpkg -i session-manager-plugin.deb
      cd $THEIA_WORKSPACE_ROOT
      cd backend-flask
```

create a new folder ssm at the path /backend-flask/bin/ and create the new file connect-to-backend-flask and connect-to-frontend-react-js and apply execution permissions `chmod u+x` The basic format is as shown below
```
#! /usr/bin/bash

if [ -z "$1" ]; then
    echo "No TASK_ID argument supplied eg ./bin/ecs/connect-to service 291661114f174777aeeaff30522b972d backend-flask"
    exit 1
fi
TASK_ID=$1

if [ -z "$2" ]; then
    echo "No CONTAINER_NAME argument supplied eg ./bin/ecs/connect-to service 291661114f174777aeeaff30522b972d backend-flask"
    exit 2
fi
CONTAINER_NAME=$2


aws ecs execute-command  \
    --region $AWS_DEFAULT_REGION \
    --cluster cruddur \
    --task $TASK_ID \
    --container $CONTAINER_NAME \
    --command "/bin/bash" \
    --interactive
```

*check <bold><i>health checks</i></bold>

-> Backend
Run `./bin/flaskhealth-check`

![Healthcheck confirmation backend](https://github.com/Stevecmd/aws-bootcamp-cruddur-2023/blob/main/journal/Week%206/backend%20health%20check%20running.JPG)

-> Frontend
![Healthcheck confirmation on browser](https://github.com/Stevecmd/aws-bootcamp-cruddur-2023/blob/main/journal/Week%206/working%20health%20check%20docker%20image.JPG)


# Create a load balancer

add the following code on your service-backend-flask.json

```
    "loadBalancers": [
      {
          "targetGroupArn": "arn:aws:elasticloadbalancing:us-east-1:<AWS Account ID>:targetgroup/cruddur-backend-flask-TG/<random TG ID>",
          "containerName": "backend-flask",
          "containerPort": 4567
      }
    ],
```

create the frontend task definition called frontend-react-js.json under /aws/task-definition

```
{
    "family": "frontend-react-js",
    "executionRoleArn": "arn:aws:iam::<AWS Account ID>:role/CruddurServiceExecutionRole",
    "taskRoleArn": "arn:aws:iam::<AWS Account ID>:role/CruddurTaskRole",
    "networkMode": "awsvpc",
    "cpu": "256",
    "memory": "512",
    "requiresCompatibilities": [ 
      "FARGATE" 
    ],
    "containerDefinitions": [
      {
        "name": "frontend-react-js",
        "image": "<AWS Account ID>.dkr.ecr.us-east-1.amazonaws.com/frontend-react-js:latest",
        "essential": true,
        "healthCheck": {
          "command": [
            "CMD-SHELL",
            "curl -f http://localhost:3000 || exit 1"
          ],
          "interval": 30,
          "timeout": 5,
          "retries": 3
        },
        "portMappings": [
          {
            "containerPort": 3000,
            "protocol": "tcp"
          }
        ],
  
        "logConfiguration": {
          "logDriver": "awslogs",
          "options": {
              "awslogs-group": "cruddur",
              "awslogs-region": "us-east-1",
              "awslogs-stream-prefix": "frontend-react-js"
          }
        }
      }
    ]
  }
```

* create the frontend task definition

` aws ecs register-task-definition --cli-input-json file://aws/task-definitions/frontend-react-js.json `

* Create frontend service
`aws ecs create-service --cli-input-json file://aws/json/service-frontend-react-js.json`

* Create dockerfile.prod in frontend

Create front end repo
```aws ecr create-repository \
  --repository-name frontend-react-js \
  --image-tag-mutability MUTABLE
  ```

Build backend and map port
```docker build \
--build-arg REACT_APP_BACKEND_URL="http://cruddur-alb-39461277.us-east-1.elb.amazonaws.com:4567" \
--build-arg REACT_APP_AWS_PROJECT_REGION="$AWS_DEFAULT_REGION" \
--build-arg REACT_APP_AWS_COGNITO_REGION="$AWS_DEFAULT_REGION" \
--build-arg REACT_APP_AWS_USER_POOLS_ID="ca-central-1_<unique-number>" \
--build-arg REACT_APP_CLIENT_ID="<unique client ID>" \
-t frontend-react-js \
-f Dockerfile.prod \
.
```

Tag Image
`docker tag frontend-react-js:latest $ECR_FRONTEND_REACT_URL:latest`

Push it
`docker push $ECR_FRONTEND_REACT_URL:latest`

If you want to run and test it

`docker run --rm -p 3000:3000 -it frontend-react-js`

<Bold> Part 2 </Bold>

Create frontend service if not already running:

`aws ecs create-service --cli-input-json file://aws/json/service-frontend-react-js.json`

Build frontend image locally - must be in front end react folder
```docker build \
--build-arg REACT_APP_BACKEND_URL="https://4567-$GITPOD_WORKSPACE_ID.$GITPOD_WORKSPACE_CLUSTER_HOST" \
--build-arg REACT_APP_AWS_PROJECT_REGION="$AWS_DEFAULT_REGION" \
--build-arg REACT_APP_AWS_COGNITO_REGION="$AWS_DEFAULT_REGION" \
--build-arg REACT_APP_AWS_USER_POOLS_ID="us-east-1_<unique-number>" \
--build-arg REACT_APP_CLIENT_ID="<unique client ID>" \
-t frontend-react-js \
-f Dockerfile.prod \
.
```
Build frontend image in prod: 
![build frontend image in prod](https://github.com/Stevecmd/aws-bootcamp-cruddur-2023/blob/main/journal/Week%206/npm%20run%20build%20on%20frontend.JPG)

If you want to run and test the image locally

`docker ps --to get <container id>`

`docker run --rm -p 3000:3000 -it frontend-react-js`

`docker inspect --to get <container id>`

Register Task Definition
`aws ecs register-task-definition --cli-input-json file://aws/task-definitions/frontend-react-js.json`

# Connecting to the frontend container once running: 
`./bin/ecs/connect-to-frontend-react-js <task number>`

# Connecting to the backend container once running: 
![Frontend container connection](https://github.com/Stevecmd/aws-bootcamp-cruddur-2023/blob/main/journal/Week%206/succesfull%20connection%20to%20task.JPG)

# Update dockerfile.prod with actual prod input
```
# Base Image ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
FROM node:16.18 AS build

ARG REACT_APP_BACKEND_URL
ARG REACT_APP_AWS_PROJECT_REGION
ARG REACT_APP_AWS_COGNITO_REGION
ARG REACT_APP_AWS_USER_POOLS_ID
ARG REACT_APP_CLIENT_ID

ENV REACT_APP_BACKEND_URL=$REACT_APP_BACKEND_URL
ENV REACT_APP_AWS_PROJECT_REGION=$REACT_APP_AWS_PROJECT_REGION
ENV REACT_APP_AWS_COGNITO_REGION=$REACT_APP_AWS_COGNITO_REGION
ENV REACT_APP_AWS_USER_POOLS_ID=$REACT_APP_AWS_USER_POOLS_ID
ENV REACT_APP_CLIENT_ID=$REACT_APP_CLIENT_ID

COPY . ./frontend-react-js
WORKDIR /frontend-react-js
RUN npm install
RUN npm run build

![Build the frontend image](https://github.com/Stevecmd/aws-bootcamp-cruddur-2023/blob/main/journal/Week%206/npm%20run%20build%20on%20frontend.JPG)

# New Base Image ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
FROM nginx:1.23.3-alpine

# --from build is coming from the Base Image
COPY --from=build /frontend-react-js/build /usr/share/nginx/html
COPY --from=build /frontend-react-js/nginx.conf /etc/nginx/nginx.conf

EXPOSE 3000
```

create a file called nginx.conf under the frontend-react-js
```
# Set the worker processes
worker_processes 1;

# Set the events module
events {
  worker_connections 1024;
}

# Set the http module
http {
  # Set the MIME types
  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  # Set the log format
  log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

  # Set the access log
  access_log  /var/log/nginx/access.log main;

  # Set the error log
  error_log /var/log/nginx/error.log;

  # Set the server section
  server {
    # Set the listen port
    listen 3000;

    # Set the root directory for the app
    root /usr/share/nginx/html;

    # Set the default file to serve
    index index.html;

    location / {
        # First attempt to serve request as file, then
        # as directory, then fall back to redirecting to index.html
        try_files $uri $uri/ $uri.html /index.html;
    }

    # Set the error page
    error_page  404 /404.html;
    location = /404.html {
      internal;
    }

    # Set the error page for 500 errors
    error_page  500 502 503 504  /50x.html;
    location = /50x.html {
      internal;
    }
  }
}

```

from the folder frontend-react-js run the command to build:

`npm run build`

run the following command to build the image pointing to the local environment:

``` docker build \
--build-arg REACT_APP_BACKEND_URL="https://${CODESPACE_NAME}-4567.${GITHUB_CODESPACES_PORT_FORWARDING_DOMAIN}" \
--build-arg REACT_APP_AWS_PROJECT_REGION="$AWS_DEFAULT_REGION" \
--build-arg REACT_APP_AWS_COGNITO_REGION="$AWS_DEFAULT_REGION" \
--build-arg REACT_APP_AWS_USER_POOLS_ID="$AWS_USER_POOLS_ID" \
--build-arg REACT_APP_CLIENT_ID="$APP_CLIENT_ID" \
-t frontend-react-js \
-f Dockerfile.prod \
.
```

To point to the url of the load balancer:

```
docker build \
--build-arg REACT_APP_BACKEND_URL="http://cruddur-alb-<AWS Account ID>.<AWS_DEFAULT_REGION>.elb.amazonaws.com:4567" \
--build-arg REACT_APP_AWS_PROJECT_REGION="$AWS_DEFAULT_REGION" \
--build-arg REACT_APP_AWS_COGNITO_REGION="$AWS_DEFAULT_REGION" \
--build-arg REACT_APP_AWS_USER_POOLS_ID="$AWS_USER_POOLS_ID" \
--build-arg REACT_APP_CLIENT_ID="$APP_CLIENT_ID" \
-t frontend-react-js \
-f Dockerfile.prod \
.
```

create the repo for the frontend ECR:

``` aws ecr create-repository \
  --repository-name frontend-react-js \
  --image-tag-mutability MUTABLE
```

and set the environment variables:

```export ECR_FRONTEND_REACT_URL="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/frontend-react-js"
echo $ECR_FRONTEND_REACT_URL
```

tag the production image:

`docker tag frontend-react-js:latest $ECR_FRONTEND_REACT_URL:latest`

test locally:

`docker run --rm -p 3000:3000 -it frontend-react-js `

push to the repo in ecr:

`docker push $ECR_FRONTEND_REACT_URL:latest`

# Implement SSL and configure DNS from the Route 53 console
* Create a hosted zone
* Update name servers
* Request public certificate under ACM
* At previously created hosted zone, create CNAME records and point them to the load balancer
  `frontend - port 3000`
  `backend - port 4567`

In the task definition of the backend, edit the following line:
```
   {"name": "FRONTEND_URL", "value": "https://example.com"},
   {"name": "BACKEND_URL", "value": "https://api.example.com"},
```

once done, relaunch the task definition, recreate the image of the frontend repo and push it.
```
docker build \
--build-arg REACT_APP_BACKEND_URL="https://example.com" \
--build-arg REACT_APP_AWS_PROJECT_REGION="$AWS_DEFAULT_REGION" \
--build-arg REACT_APP_AWS_COGNITO_REGION="$AWS_DEFAULT_REGION" \
--build-arg REACT_APP_AWS_USER_POOLS_ID="$AWS_USER_POOLS_ID" \
--build-arg REACT_APP_CLIENT_ID="$APP_CLIENT_ID" \
-t frontend-react-js \
-f Dockerfile.prod \
.
```